name: Testes Robot Framework

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permite execução manual

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Instalar dependências
      run: |
        python -m pip install --upgrade pip
        pip install robotframework==7.0
        pip install robotframework-requests==0.9.7
        pip install robotframework-jsonlibrary==0.5
        pip install requests==2.31.0
    
    - name: Criar estrutura de diretórios
      run: |
        mkdir -p reports/{html,xml,logs,screenshots}
    
    - name: Executar testes JSON
      continue-on-error: true
      run: |
        robot --outputdir reports/html \
              --output reports/xml/json-output.xml \
              --log reports/logs/json-log.html \
              --report reports/html/json-report.html \
              --include JSON \
              --name "Testes JSON" \
              tests/ || echo "Testes JSON concluídos com falhas"
    
    - name: Executar testes dinâmicos
      continue-on-error: true
      run: |
        robot --outputdir reports/html \
              --output reports/xml/dinamico-output.xml \
              --log reports/logs/dinamico-log.html \
              --report reports/html/dinamico-report.html \
              --include dinamico \
              --name "Testes Dinâmicos" \
              tests/ || echo "Testes dinâmicos concluídos com falhas"
    
    - name: Executar testes de manipulação
      continue-on-error: true
      run: |
        robot --outputdir reports/html \
              --output reports/xml/manipulacao-output.xml \
              --log reports/logs/manipulacao-log.html \
              --report reports/html/manipulacao-report.html \
              --include MANIPULACAO \
              --name "Testes de Manipulação" \
              tests/ || echo "Testes de manipulação concluídos com falhas"
    
    - name: Gerar relatório consolidado
      if: always()
      run: |
        rebot --outputdir reports/html \
              --output reports/xml/consolidated-output.xml \
              --log reports/logs/consolidated-log.html \
              --report reports/html/consolidated-report.html \
              --name "Relatório Consolidado" \
              reports/xml/*-output.xml || echo "Relatório consolidado gerado"
    
    - name: Upload dos resultados
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: relatorios-robot-${{ github.run_number }}
        path: reports/
        retention-days: 30
    
    - name: Publicar resultados dos testes
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: reports/xml/*.xml
        check_name: "Resultados dos Testes Robot Framework"
        comment_title: "📊 Relatório de Testes"
    
    - name: Comentário com resumo
      if: always()
      run: |
        echo "## 📊 Resumo da Execução" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Testes JSON executados" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Testes dinâmicos executados" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Testes de manipulação executados" >> $GITHUB_STEP_SUMMARY
        echo "- 📁 Relatórios disponíveis nos artefatos" >> $GITHUB_STEP_SUMMARY

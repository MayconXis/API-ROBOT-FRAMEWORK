name: Testes Robot Framework

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout do cÃ³digo
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Instalar dependÃªncias
      run: |
        python -m pip install --upgrade pip
        pip install robotframework==7.0
        pip install robotframework-requests==0.9.7
        pip install robotframework-jsonlibrary==0.5
        pip install requests==2.31.0
    
    - name: Criar estrutura de diretÃ³rios
      run: |
        mkdir -p reports/{html,xml,logs,screenshots}
    
    - name: Executar testes JSON
      continue-on-error: true
      run: |
        robot --outputdir reports/html \
              --output reports/xml/json-output.xml \
              --log reports/logs/json-log.html \
              --report reports/html/json-report.html \
              --include JSON \
              --name "Testes JSON" \
              tests/ || echo "Testes JSON concluÃ­dos com falhas"
    
    - name: Executar testes dinÃ¢micos
      continue-on-error: true
      run: |
        robot --outputdir reports/html \
              --output reports/xml/dinamico-output.xml \
              --log reports/logs/dinamico-log.html \
              --report reports/html/dinamico-report.html \
              --include dinamico \
              --name "Testes DinÃ¢micos" \
              tests/ || echo "Testes dinÃ¢micos concluÃ­dos com falhas"
    
    - name: Executar testes de manipulaÃ§Ã£o
      continue-on-error: true
      run: |
        robot --outputdir reports/html \
              --output reports/xml/manipulacao-output.xml \
              --log reports/logs/manipulacao-log.html \
              --report reports/html/manipulacao-report.html \
              --include MANIPULACAO \
              --name "Testes de ManipulaÃ§Ã£o" \
              tests/ || echo "Testes de manipulaÃ§Ã£o concluÃ­dos com falhas"
    
    - name: Gerar relatÃ³rio consolidado
      if: always()
      run: |
        rebot --outputdir reports/html \
              --output reports/xml/consolidated-output.xml \
              --log reports/logs/consolidated-log.html \
              --report reports/html/consolidated-report.html \
              --name "RelatÃ³rio Consolidado" \
              reports/xml/*-output.xml || echo "RelatÃ³rio consolidado gerado"
    
    - name: Upload dos resultados
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: relatorios-robot-${{ github.run_number }}
        path: reports/
        retention-days: 30
    
    - name: Publicar resultados dos testes
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: reports/xml/*.xml
        check_name: "Resultados dos Testes Robot Framework"
        comment_title: "ðŸ“Š RelatÃ³rio de Testes"
    
    - name: ComentÃ¡rio com resumo
      if: always()
      run: |
        echo "## ðŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Testes JSON executados" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Testes dinÃ¢micos executados" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Testes de manipulaÃ§Ã£o executados" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ RelatÃ³rios disponÃ­veis nos artefatos" >> $GITHUB_STEP_SUMMARY
